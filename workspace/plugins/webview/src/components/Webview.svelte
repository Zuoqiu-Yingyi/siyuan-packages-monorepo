<!--
 Copyright (C) 2023 Zuoqiu Yingyi
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU Affero General Public License as
 published by the Free Software Foundation, either version 3 of the
 License, or (at your option) any later version.
 
 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU Affero General Public License for more details.
 
 You should have received a copy of the GNU Affero General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<script lang="ts">
    import { onMount } from "svelte";
    import { fade } from "svelte/transition";

    import Tab from "@workspace/components/siyuan/tab/Tab.svelte";
    import BlockIcon from "@workspace/components/siyuan/misc/BlockIcon.svelte";
    import { TooltipsDirection } from "@workspace/components/siyuan/misc/tooltips";
    import type { Electron } from "@workspace/types/electron";
    import type WebviewPlugin from "@/index";
    import type { I18N } from "@/utils/i18n";

    export let src: string;
    export let tab: any;
    export let plugin: InstanceType<typeof WebviewPlugin>;

    export let useragent: string = plugin.useragent; // 用户代理
    export let background: string = plugin.background; // 用户代理

    const i18n = plugin.i18n as unknown as I18N;

    let fullscreen = false; // 是否为全屏模式
    let can_back = false; // 能否转到上一页
    let can_forward = false; // 能否转到下一页
    let loading = false; // 页面是否正在加载
    let address = decodeURI(src); // 地址栏
    let devtools_opened = false; // 开发者工具是否已打开
    let webview: Electron.WebviewTag; // webview 标签
    let webview_pointer_events_disable = false; // 是否禁用 webview 的鼠标事件

    let status_display = false; // 状态栏显示状态
    let status = ""; // 状态栏内容

    /* 转到上一页 */
    function onGoBack() {
        if (can_back) {
            webview?.goBack();
        }
    }

    /* 转到下一页 */
    function onGoForward() {
        if (can_back) {
            webview?.goBack();
        }
    }

    /* 刷新或终止加载按钮 */
    function onRefreshOrStop() {
        if (loading) {
            webview?.stop();
        } else {
            webview?.reload();
        }
    }

    /* 地址栏存在来自外部更改 */
    function onAddressChange(e) {
        // plugin.logger.debug(e);

        if (address) {
            try {
                const url = new URL(address);
                webview.loadURL(url.href);
            } catch (e) {
                try {
                    const url = new URL(`http://${address}`);
                    webview.loadURL(url.href.replace(/^http:/, ""));
                } catch (error) {
                    plugin.siyuan.showMessage(`${plugin.name}:\nURL <code class="fn__code">${address}</code> ${i18n.message.nonStandardURL}\n`, undefined, "error");
                }
            }
        }
    }

    /* 使用默认程序打开 */
    function onOpenWithDefaultProgram() {
        global.open(tab.data.href, "_blank");
    }

    /* 在新窗口打开 */
    function onOpenWithNewWindow(e: MouseEvent) {
        plugin.openWindow(tab.data.href, {
            x: e.screenX,
            y: e.screenY,
            title: tab.data.title,
        });
    }

    /* 进入/退出全屏模式 */
    function onEnterOrExitFullscreen() {
        fullscreen = !fullscreen;
    }

    /* 打开/关闭开发者工具 */
    function onOpenOrCloseDevTools() {
        if (webview) {
            if (webview.isDevToolsOpened()) {
                webview.closeDevTools();
            } else {
                webview.openDevTools();
            }
        }
    }

    onMount(() => {
        /**
         * 监听页面变化
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-load-commit
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-will-navigate
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-did-start-navigation
         */
        webview.addEventListener("load-commit", e => {
            // plugin.logger.debug(e)
            /* 更新地址栏地址 */
            if (e.isMainFrame) {
                address = decodeURI(e.url);
                tab.data.href = e.url;
            }

            /* 是否可后退 */
            // REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#webviewcangoback
            can_back = webview.canGoBack();

            /* 是否可前进 */
            // REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#webviewcangoback
            can_forward = webview.canGoForward();
        });

        /**
         * 更改页签标题
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#%E4%BA%8B%E4%BB%B6-page-title-updated
         */
        webview.addEventListener("page-title-updated", e => {
            // plugin.logger.debug(e)
            // plugin.logger.debug(tab);
            tab.data.title = e.title;
            tab.tab.updateTitle(e.title);
            tab.tab.headElement.ariaLabel = e.title;
        });

        /**
         * 更改页签图标
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#%E4%BA%8B%E4%BB%B6-page-favicon-updated
         */
        webview.addEventListener("page-favicon-updated", e => {
            // plugin.logger.debug(e)
            const favicons = e.favicons;

            /* 删除原生 svg 图标 */
            tab.tab.headElement.querySelector(".item__graphic")?.remove();

            if (favicons.length > 0) {
                const favicon = favicons[0]; // 图标地址
                const iconElement = tab.tab.headElement.querySelector(".item__icon"); // 图标容器

                /* 图标容器不存在或者图标地址更改时插入/更新图标 */
                if (tab.tab.docIcon !== favicon || !iconElement) {
                    tab.tab.docIcon = favicon;
                    const img = `<img src="${favicon}" />`; // 在线图标

                    /* 设置图标 */
                    if (iconElement) {
                        // 更新图标
                        iconElement.innerHTML = img;
                    } else {
                        // 插入图标
                        tab.tab.headElement.insertAdjacentHTML("afterbegin", `<span class="item__icon">${img}</span>`);
                    }
                }
            } else {
                /* 设置默认图标 */
                tab.tab.setDocIcon("🌐".codePointAt(0).toString(16), true);
            }
        });

        /**
         * 加载时 & 加载完成设置不同的状态
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-did-start-loading
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-did-stop-loading
         */
        /* 开始加载 */
        webview.addEventListener("did-start-loading", _ => {
            // plugin.logger.debug(e)
            loading = true;
        });
        /* 停止加载 */
        webview.addEventListener("did-stop-loading", _ => {
            // plugin.logger.debug(e)
            loading = false;
        });

        /**
         * 开发者工具中打开超链接
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-devtools-open-url
         */
        webview.addEventListener("devtools-open-url", e => {
            // plugin.logger.debug(e);
            plugin.openWebviewTab(e.url);
        });

        /**
         * 开启/关闭开发者工具
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-devtools-opened
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-devtools-closed
         */
        webview.addEventListener("devtools-opened", e => (devtools_opened = true));
        webview.addEventListener("devtools-closed", e => (devtools_opened = false));

        /**
         * 焦点为链接时在状态栏显示链接
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-update-target-url
         */
        webview.addEventListener("update-target-url", e => {
            // plugin.logger.debug(e);

            if (e.url) {
                status = e.url;
                if (!status_display) {
                    status_display = true;
                }
            } else {
                status_display = false;
            }
        });

        /**
         * 上下文菜单(右键触发)
         * REF https://www.electronjs.org/zh/docs/latest/api/webview-tag#event-context-menu
         */
        webview.addEventListener("context-menu", e => {
            plugin.logger.debug(e);

            /* 在超链接上激活上下文菜单(右键点击/键盘上下文键) */
            if (e.params.linkURL) {
                plugin.openWebviewTab(e.params.linkURL, e.params.titleText || e.params.linkText || e.params.altText);
            }
        });
    });
</script>

<Tab {fullscreen}>
    <!-- 地址栏 -->
    <div
        slot="breadcrumb"
        class="protyle-breadcrumb"
    >
        <!-- 后退按钮 -->
        <BlockIcon
            on:click={onGoBack}
            icon="#iconLeft"
            ariaLabel={i18n.webview.goForwardOnePage}
            disabled={!can_back}
            tooltipsDirection={TooltipsDirection.se}
        />

        <!-- 前进按钮 -->
        <BlockIcon
            on:click={onGoForward}
            icon="#iconRight"
            ariaLabel={i18n.webview.goBackOnePage}
            disabled={!can_forward}
            tooltipsDirection={TooltipsDirection.se}
        />

        <!-- 刷新/终止加载按钮 -->
        <BlockIcon
            on:click={onRefreshOrStop}
            icon={loading ? "#iconClose" : "#iconRefresh"}
            ariaLabel={loading ? i18n.webview.stopLoadingThisPage : i18n.webview.reloadCurrentPage}
            tooltipsDirection={TooltipsDirection.se}
        />

        <!-- <div class="fn__space" /> -->

        <!-- 地址输入框 -->
        <input
            on:change={onAddressChange}
            bind:value={address}
            class="b3-text-field fn__flex-1 address-field"
            type="url"
        />

        <!-- <div class="fn__space" /> -->

        <!-- 使用默认程序(一般为浏览器)打开当前页面链接 -->
        <BlockIcon
            on:click={onOpenWithDefaultProgram}
            icon="#iconLanguage"
            ariaLabel={i18n.webview.openWithDefaultProgram}
            tooltipsDirection={TooltipsDirection.sw}
        />

        <!-- 使用新窗口打开当前页面链接 -->
        <BlockIcon
            on:click={onOpenWithNewWindow}
            icon="#iconOpenWindow"
            ariaLabel={i18n.webview.openWithNewWindow}
            tooltipsDirection={TooltipsDirection.sw}
        />

        <!-- 打开/关闭全屏模式 -->
        <BlockIcon
            on:click={onEnterOrExitFullscreen}
            icon={fullscreen ? "#iconFullscreenExit" : "#iconFullscreen"}
            ariaLabel={fullscreen ? i18n.webview.exitFullscreen : i18n.webview.enterFullscreen}
            active={fullscreen}
            tooltipsDirection={TooltipsDirection.sw}
        />

        <!-- 打开/关闭开发者工具 -->
        <BlockIcon
            on:click={onOpenOrCloseDevTools}
            icon="#iconBug"
            ariaLabel={devtools_opened ? i18n.webview.closeDevTools : i18n.webview.openDevTools}
            active={devtools_opened}
            tooltipsDirection={TooltipsDirection.sw}
        />
    </div>

    <!-- 主体 -->
    <!-- svelte-ignore a11y-no-static-element-interactions -->
    <div
        slot="content"
        on:mouseenter={e => (webview_pointer_events_disable = e.button === 0 ? false : true)}
        on:mouseleave={() => (webview_pointer_events_disable = true)}
        class="content fn__flex fn__flex-1"
    >
        <webview
            bind:this={webview}
            {src}
            {useragent}
            style:background
            class:pointer-events-disable={webview_pointer_events_disable}
            class="webview fn__flex-1"
            allowpopups
        />
        {#if status_display}
            <!-- 状态提示 (显示超链接地址) -->
            <div
                class="webview-status tooltip"
                in:fade={{ delay: 0, duration: 125 }}
                out:fade={{ delay: 500, duration: 250 }}
            >
                <span>{status}</span>
            </div>
        {/if}
    </div>
</Tab>

<style lang="less">
    .protyle-breadcrumb {
        height: 32px;

        .address-field {
            margin: 4px;
        }
    }

    // .protyle-preview {
    //     user-select: none;
    // }
    .content {
        user-select: none;
    }

    .webview-status {
        position: absolute;
        bottom: 0;
        left: 0;
    }

    .pointer-events-disable {
        pointer-events: none;
    }
</style>
